import{_ as s,o as a,c as n,Q as p}from"./chunks/framework.d084db19.js";const m=JSON.parse('{"title":"8系项目升级（如何实现数据库8.2升级到8.5）","description":"","frontmatter":{"title":"8系项目升级（如何实现数据库8.2升级到8.5）","date":"2021-11-16T09:43:05.000Z"},"headers":[],"relativePath":"doc/wpdoc/8系项目升级（如何实现数据库8.2升级到8.5）.md","filePath":"doc/wpdoc/8系项目升级（如何实现数据库8.2升级到8.5）.md"}'),l={name:"doc/wpdoc/8系项目升级（如何实现数据库8.2升级到8.5）.md"},o=p(`<h1 id="_8系项目升级-如何实现数据库8-2升级到8-5" tabindex="-1">8系项目升级（如何实现数据库8.2升级到8.5） <a class="header-anchor" href="#_8系项目升级-如何实现数据库8-2升级到8-5" aria-label="Permalink to &quot;8系项目升级（如何实现数据库8.2升级到8.5）&quot;">​</a></h1><h2 id="一、升级背景" tabindex="-1">一、升级背景 <a class="header-anchor" href="#一、升级背景" aria-label="Permalink to &quot;一、升级背景&quot;">​</a></h2><p>在比较老的8系项目中，有很多项目还是基于8.1、8.2的服务，但因业务扩展需要，8.1、8.2服务支持的功能已经不能满足客户的要求，类似于8.5支持的新拜访流、新导入导出、不规则导出等服务，为了满足客户需求的同时又能提高使用便捷性，故设计了8系项目升级的组件。</p><h2 id="二、适用背景" tabindex="-1">二、适用背景 <a class="header-anchor" href="#二、适用背景" aria-label="Permalink to &quot;二、适用背景&quot;">​</a></h2><p>本组件升级的条件适用于原服务版本是8.1、8.2的8系项目，通过一系列和标准8.5比对和对数据库表的操作把数据库升级到8.5，并且保证环境能够正常使用，请注意，7系项目未测试验证。</p><h2 id="三、升级步骤流程" tabindex="-1">三、升级步骤流程 <a class="header-anchor" href="#三、升级步骤流程" aria-label="Permalink to &quot;三、升级步骤流程&quot;">​</a></h2><p>涉及到数据和资料的我放在8.2升级8.5的文件夹里，有需要的到这个文件夹里面找，如下我主要介绍8.2升级的步骤：</p><h3 id="_1、搭建8-5环境的框架" tabindex="-1">1、搭建8.5环境的框架 <a class="header-anchor" href="#_1、搭建8-5环境的框架" aria-label="Permalink to &quot;1、搭建8.5环境的框架&quot;">​</a></h3><p>这个需要找运维同事帮忙，从公有云把8.2生产环境单独拿出来，新开一个实施环境，然后把服务升级到8.5，此时，具有8.5的框架但是数据库版本还是8.2的实施环境就搭建好了。那么，如何去验证是不是已经是8.5的服务了呢？这个时候可以去元数据库中的meta_model 表查看，如下图所示：</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D2121.png" alt=""></p><p>如果通过select * from meta_model where tenantcode =&#39;1008415&#39;(业务库企业号)查找出来的productversioncode=834686017469201851，那就说明环境已经是8.5的框架了。如果不是，那自己手动修改update meta_model set productversioncode=&#39;834686017469201851&#39; where tenantcode =&#39;1008415&#39;（此时，库里面还没存在8.5开户租户，稍后会说）;</p><h3 id="_2、数据库结构对比" tabindex="-1">2、数据库结构对比 <a class="header-anchor" href="#_2、数据库结构对比" aria-label="Permalink to &quot;2、数据库结构对比&quot;">​</a></h3><p><strong>2.1</strong> 首先，需要一个标准8.5的环境，可以用自己组内的8.5实施环境，然后业务库选择一个未在其他项目使用的业务库(这里我选择P6V26实施环境tenant_1011036)，接着分别用navicat对标准8.5环境和8.2环境的数据库做结构比对，数据库分别为元数据库（xw_metadata）、平台库（xw_platform）、业务库（tenant_1011036），具体操作：navicat--&gt;工具--&gt;结构对比，如下图：</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D2597.png" alt=""></p><p><strong>2.2</strong>选择选项，选择需要比对的选项，一般来说比对主键、视图、函数就可，如下图：</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D2639.png" alt=""></p><p><strong>2.3</strong>选择完之后开始比对数据，稍等几分等加载完成，结果是是要修改的对象、要增加的对象、和要删除的对象，注意此时一定不能勾选要删除的对象，接着我们先选择要修改的对象，一般来说对于bi_等开头的表基本上都是报表，我们不需要勾选，但是为了保持一致性，建议大家把bi_相关的表也勾选上，然后点击部署，这个时候可以看到会生成对应的sql脚本，此时一定不能直接运行（很重要！！！），如果直接点击运行，会导致目标库即8.2的库丢失数据，正确做法是把脚本复制出来，比如我是复制到Notepad++做进一步完善，实际上比对修改的对象的sql脚本是有很多DROP语句的，故我们需要把DROP语句的sql去掉，按照表格、函数、视图等分类，如下图：</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D2954.png" alt=""></p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D2956.png" alt=""></p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D2958.png" alt=""></p><p><strong>2.4</strong>要修改的对象整理好了，再整理要新增的对象，步骤和要修改的对象一样，只不过要新增的对象的sql脚本没有DROP语句，所以不用删除sql语句，直接按照表格、视图、函数分类整理好就行。上面演示的是业务库的比对，元数据库和平台库结构比对步骤和业务库一样，分类整理好。如下图：</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D3097.png" alt=""></p><h3 id="_3、新增8-5开户租户" tabindex="-1">3、新增8.5开户租户 <a class="header-anchor" href="#_3、新增8-5开户租户" aria-label="Permalink to &quot;3、新增8.5开户租户&quot;">​</a></h3><p><strong>3.1</strong> 在标准8.5实施环境的元数据库的meta_model中查找到8.5开户租户这条记录，把sql复制为新增语句：</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D3168.png" alt=""></p><p><strong>3.2</strong>拿到上面复制的sql语句：</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;public&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#9ECBFF;">&quot;meta_model&quot;</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;metamodelcode&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;metamodelname&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;status&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;metamodeltype&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;productcode&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;productversioncode&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;tenantcode&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">829609839767532851</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;快销V8.5.1-base开发租户&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">834683221240184837</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">834686017469201851</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1008851</span><span style="color:#E1E4E8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;public&quot;</span><span style="color:#24292E;">.</span><span style="color:#032F62;">&quot;meta_model&quot;</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;metamodelcode&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;metamodelname&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;status&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;metamodeltype&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;productcode&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;productversioncode&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;tenantcode&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">829609839767532851</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;快销V8.5.1-base开发租户&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">834683221240184837</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">834686017469201851</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1008851</span><span style="color:#24292E;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>直接拿到8.2的环境中元数据库和平台库中执行，这个时候就和第一个步骤说的8.5的框架的环境对应上了，如果当时在第一个步骤中没有把8.5的productversioncode业务库关联起来，那么这个时候就必须要把这个关系维护好了，不然没法继续操作。</p><h3 id="_4、数据库其他额外操作" tabindex="-1">4、数据库其他额外操作 <a class="header-anchor" href="#_4、数据库其他额外操作" aria-label="Permalink to &quot;4、数据库其他额外操作&quot;">​</a></h3><p><strong>4.1</strong> 元数据库（xw_metadata）：需要对bi_datasource 、meta_model 、meta_directorytype 、biz_center等表做修改新增操作，具体sql我放在xw_metadata 额外 .txt这个文件，大家可以参考这个，视情况而定。</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D3710.png" alt=""></p><p><strong>4.2</strong> 平台库（xw_platform）：平台库需要额外才做比较多，包括表、视图、函数都有，具体的sql我放在xw_platform 额外 .txt这个文件，大家可以参考这个，视情况而定。</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D3807.png" alt=""></p><h3 id="_5、标准8-5相关数据" tabindex="-1">5、标准8.5相关数据 <a class="header-anchor" href="#_5、标准8-5相关数据" aria-label="Permalink to &quot;5、标准8.5相关数据&quot;">​</a></h3><p><strong>5.1</strong> 如果按照上面的步骤方法，那么到现在基本上你的框架就搭建完了，也就是说现在的环境是已经是8.5的环境了，但此时升级还没完成，框架和环境都有了，但是数据还是8.2的数据，所以此时我们需要找到标准8.5的数据，那怎么找标准8.5的数据呢？这个时候就又回到了前面插入的那条8.5的开户租户了，细心一点就会发现productversioncode=&#39;834686017469201851&#39;这个关键，&#39;834686017469201851&#39;是标准8.5的productversioncode值，步骤一开始我们就已经做了update meta_model set productversioncode=&#39;834686017469201851&#39; where tenantcode =&#39;1008415&#39;这个操作，这个sql语句的意思是把业务库修改为8.5，在meta_model中找到8.5开户对应的metamodelcode，这个metamodelcode就是我们在标准8.5中找标准数据的关键，就是我们要在标准8.5的实施环境中找到所有用到这个字段的表，然后把这些表结果和数据导出来整理好。</p><p><strong>5.2</strong> 在元数据中执行下面这段代码，就能找到所有用到metamodelcode字段的表。</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">base.</span><span style="color:#9ECBFF;">&quot;table_name&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">base.</span><span style="color:#9ECBFF;">&quot;column_name&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">col_description ( </span><span style="color:#79B8FF;">t1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">attnum</span><span style="color:#E1E4E8;"> ),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">base</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">udt_name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">COALESCE</span><span style="color:#E1E4E8;"> ( character_maximum_length, numeric_precision, datetime_precision ),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">CASE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">attnum</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ANY ( conkey ) </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> pg_constraint </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> conrelid </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> contype </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;p&#39;</span><span style="color:#E1E4E8;"> ) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;t&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">information_schema</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">COLUMNS</span><span style="color:#E1E4E8;"> base,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">pg_class t1,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">pg_attribute t2 </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">WHERE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">t1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> base.</span><span style="color:#9ECBFF;">&quot;table_name&quot;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">attname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> base.</span><span style="color:#9ECBFF;">&quot;column_name&quot;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">attrelid</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">attnum</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> base.</span><span style="color:#9ECBFF;">&quot;column_name&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> ( </span><span style="color:#9ECBFF;">&#39;metamodelcode&#39;</span><span style="color:#E1E4E8;"> );</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">base.</span><span style="color:#032F62;">&quot;table_name&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">base.</span><span style="color:#032F62;">&quot;column_name&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">col_description ( </span><span style="color:#005CC5;">t1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">attnum</span><span style="color:#24292E;"> ),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">base</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">udt_name</span><span style="color:#24292E;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">COALESCE</span><span style="color:#24292E;"> ( character_maximum_length, numeric_precision, datetime_precision ),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">CASE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">attnum</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ANY ( conkey ) </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> pg_constraint </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> conrelid </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> contype </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;p&#39;</span><span style="color:#24292E;"> ) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;t&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">information_schema</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">COLUMNS</span><span style="color:#24292E;"> base,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">pg_class t1,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">pg_attribute t2 </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">WHERE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">t1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> base.</span><span style="color:#032F62;">&quot;table_name&quot;</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">attname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> base.</span><span style="color:#032F62;">&quot;column_name&quot;</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">attrelid</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">attnum</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> base.</span><span style="color:#032F62;">&quot;column_name&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> ( </span><span style="color:#032F62;">&#39;metamodelcode&#39;</span><span style="color:#24292E;"> );</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>如下图所示：</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D4956.png" alt=""></p><p>8.5标准数据我整理在xw_metadata标准8.5数据文件夹，大家可以参考，视情况而定。</p><h3 id="_6、执行脚本" tabindex="-1">6、执行脚本 <a class="header-anchor" href="#_6、执行脚本" aria-label="Permalink to &quot;6、执行脚本&quot;">​</a></h3><p>按照分类整理好的脚本文件，如下图：</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D5028.png" alt=""></p><p>分批在对应的数据库中执行脚本，等待脚本执行完成。</p><h3 id="_7、ide配置管理员" tabindex="-1">7、IDE配置管理员 <a class="header-anchor" href="#_7、ide配置管理员" aria-label="Permalink to &quot;7、IDE配置管理员&quot;">​</a></h3><p>执行完上面的脚本之后，基本上8.5的环境就升级好了，接下来就是在IDE里面给管理关联上对应的功能，也是找标准8.5环境对比，然后根据标准8.5管理员关联的功能在新升级好的8.5环境上关联起来，配置好之后整一个升级流程就完成了。</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D5178.png" alt=""></p><h2 id="四、异常排错方法" tabindex="-1">四、异常排错方法 <a class="header-anchor" href="#四、异常排错方法" aria-label="Permalink to &quot;四、异常排错方法&quot;">​</a></h2><p>数据库升级不是一蹴而就的，而是需要结合实际情况，通过在服务器打日志排查，需要结合日志分析、推理、实践、总结最后定位到具体的问题，接下来我列举一下我在升级过程中遇到的坑，以及是如何解决的。</p><h3 id="_1、ide登录报错" tabindex="-1">1、IDE登录报错 <a class="header-anchor" href="#_1、ide登录报错" aria-label="Permalink to &quot;1、IDE登录报错&quot;">​</a></h3><p>在升级过程中登录IDE直接报错，如下图：</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D5301.png" alt=""></p><p>解决方法：重启服务器，因为在元数据库做了增改操作，服务可能未完成更新，所以报错。</p><p>重启服务路径及语句：</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D5364.png" alt=""></p><p>总结：如果在元数据库和平台库做了insert 、 update操作，则需要先重启服务器，否则会不起作用。这里有一个坑，我上面截图是在backend这个目录下重启的，也就是我重启的服务是后台服务，因为我是登录IDE之后发现报错的，也就是IDE服务，然后IDE服务又在后台服务下，所以我直接重启后台服务就可以，对于不知道哪个服务放在哪个目录下的，建议在开发者网站上找。那如果我是登录web端报错呢？该怎么解决？东施效颦，web服务报错，那肯定就是先重启web服务（这里假设没有其他报错），如下图</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D5612.png" alt=""></p><p>相应就在apaas下用sh deply_all.sh restart 重启整一个apaas服务。</p><h3 id="_2、ide数据不全" tabindex="-1">2、IDE数据不全 <a class="header-anchor" href="#_2、ide数据不全" aria-label="Permalink to &quot;2、IDE数据不全&quot;">​</a></h3><p>登录IDE发现，无论是业务实体、业务领域、业务UI或者是报表，数据都不全，如下图</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D5712.png" alt=""><br><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D5713.png" alt=""></p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D5715.png" alt=""></p><p>出现这种情况主要是一开始执行了update meta_model set productversioncode=&#39;834686017469201851&#39; where tenantcode =&#39;1008415&#39;，就是说把业务库和8.5关联起来了，但是又没有把8.5的数据迁移到升级库中，所以IDE里面只找到了业务库的数据，但是8.5的数据为null，在linux服务器下打日志就会发现这个问题，如下<br><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D5915.png" alt=""></p><p>解决方法：升级环境的元数据库和查找是不是插入了8.5开户租户，如果没插入，请先插入，然后把标准8.5的数据sql脚本在升级环境执行，执行完数据就出来了。</p><h3 id="_3、web报网络异常-重启服务器也不行" tabindex="-1">3、Web报网络异常，重启服务器也不行 <a class="header-anchor" href="#_3、web报网络异常-重启服务器也不行" aria-label="Permalink to &quot;3、Web报网络异常，重启服务器也不行&quot;">​</a></h3><p>在web只要有微服务调用都报网络异常，如图</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D6034.png" alt=""></p><p>在服务器打日志发现报的错误是连接超时，再找到对应微服务接口下的日志报文，发现调用对应微服务的地址和数据库存储的微服务地址不一样，如下图：</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D6105.png" alt=""></p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D6107.png" alt=""></p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D6109.png" alt=""></p><p>而且怎么在服务器也tenlet不通，同一台机但是找不到对应的端口，<br><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D6144.png" alt=""></p><p>解决方法：1、找运维重新配套餐（看看运维同事愿不愿意帮忙改）。2、自己在IDE把微服务地址改为本地（所有微服务都需要）。如图</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D6209.png" alt=""></p><h3 id="_4、升级之后各服务版本问题" tabindex="-1">4、升级之后各服务版本问题 <a class="header-anchor" href="#_4、升级之后各服务版本问题" aria-label="Permalink to &quot;4、升级之后各服务版本问题&quot;">​</a></h3><p>例子：有时候登录web端发现并不支持le:user等用法，如图：</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D6256.png" alt=""></p><p>解决方法：这个一看就是低版本不支持导致的，找运维帮忙把web版本升级到9.2.8以上的版本就ok了。</p><p>当然还有其他容易踩坑的地方，具体的情况需要负责人自己视情况排查问题，这里我只列举了几个升级过程中比较容易碰到的坑，升级过程中需要以实际的bug为主，关键点在于要会在服务器看日志报文，然后针对报文信息定位到具体的报错点，修改逐一排查。</p><h2 id="五、总结" tabindex="-1">五、总结 <a class="header-anchor" href="#五、总结" aria-label="Permalink to &quot;五、总结&quot;">​</a></h2><p>数据库8.2升级8.5，无非就是对元数据库、平台库、业务库的insert、update操作，这里重点就是有一个标准8.5的环境作比对，在比对结构拿到sql脚本的时候注意要把DROP语句删除，分类别整理好。然后就是元数据库要存在8.5的开户租户这条记录，并且和业务库关联好，再把对应8.5标准数据迁移到升级环境中。升级过程中难免会遇到各种bug，这个只需要细心一点，就能减少很多不必要的bug，遇到bug也很好解决，充分利用服务器，查找日志报文信息定位错误，分析并解决。本组件提供一套8系低版本项目升级到8.5版本的方法和流程，并整理好了大部分标准8.5的数据，后续其他同事有升级需要的可以直接拿本组件整理好的数据，以及整理好额外需要操作的sql脚本，一并放在景兴8.2升级8.5文件夹。</p><p>相关文件下载：<br><a href="http://apaas.wxchina.com:8881/wp-content/uploads/COM-BC032-FC001-8%E7%B3%BB%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7%EF%BC%88%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%938.2%E5%8D%87%E7%BA%A7%E5%88%B08.5%EF%BC%89-v-1.0.0.zip" title="COM-BC032-FC001 8系项目升级（如何实现数据库8.2升级到8.5） v-1.0.0" target="_blank" rel="noreferrer">COM-BC032-FC001 8系项目升级（如何实现数据库8.2升级到8.5） v-1.0.0</a></p>`,82),e=[o];function t(c,E,r,B,i,y){return a(),n("div",null,e)}const d=s(l,[["render",t]]);export{m as __pageData,d as default};
