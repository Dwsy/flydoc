import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.d084db19.js";const m=JSON.parse('{"title":"导出图片改名及水印修改设计文档","description":"","frontmatter":{"title":"导出图片改名及水印修改设计文档","date":"2021-11-16T09:28:10.000Z"},"headers":[],"relativePath":"doc/wpdoc/导出图片改名及水印修改设计文档.md","filePath":"doc/wpdoc/导出图片改名及水印修改设计文档.md"}'),p={name:"doc/wpdoc/导出图片改名及水印修改设计文档.md"},o=l(`<h2 id="导出图片改名-改水印方案" tabindex="-1">导出图片改名&amp;改水印方案 <a class="header-anchor" href="#导出图片改名-改水印方案" aria-label="Permalink to &quot;导出图片改名&amp;改水印方案&quot;">​</a></h2><p>一、 业务背景</p><p>在现有项目中，很多项目需要通过工具导出图片存档或通过导出批量审核图片 (目前页面显示图片方式数据量比较小且为缩率图显示小导致审核效率低)。初始化产品中图片导出后图片名称为GUID，无具体业务含义无法快速分类和定位问题图片，此组件协助实施同事快速修改图片名称及水印提高系统价值。</p><p>二、导出图片工具存在痛点</p><ol><li>图片导出后图片名称为GUID，图片的查看查找无法快速定位。</li><li>图片导出后图片名称为GUID，无法标记图片业务内容无法体现业务机制。</li></ol><p>三、改名和水印的价值</p><ol><li><p>图片名称可以按业务需求进行定义。</p></li><li><p>系统会自动按名称进行排序，方便图片分类审核。</p></li><li><p>增加图片水印，方便图片归档后续查看。</p></li></ol><p>四、解决方案</p><p>图片在数据库中的存储本身是JSON格式，图片名称存储在数据中。通过定时任务对不同业务提交的图片进行信息补充，通过数据库jsonb函数批量修改图片中图片名称和水印字段。</p><p>数据库图片格式说明：</p><p>{</p><p>Filepath： 图片本地路径</p><p>datetime： 图片生成日期</p><p>filetype： 文件类型</p><p>httpUrl： 图片url</p><p>watermark： 水印信息</p><p>displayname：图片名称</p><p>source：图片的udid信息，即图片名</p><p>identityId： udid唯一编码</p><p>isFake： 是否翻拍</p><p>isQualified： 是否合格</p><p>unqualifiedReason： 不合格原因</p><p>detectResult： 识别结果</p><p>}</p><p>五、图片下载工具功能，使用具体操作步骤</p><p>1、图片下载工具区分32/64位操作系统，请正确选择使用。<strong>64位操作系统如果使用64位工具打不开可以下载32位工具使用</strong>。<br> 2、目前下载后的文件仅只支持WPS文档查看图片。</p><p>3、点击对应电脑版本链接后，系统已开始下载数据，由于工具包本身较大下载过程需要等待，下载完成后浏览器会弹出保存选项。</p><p><strong>1、</strong>**<em>\\</em> 将接收到的玄讯图片下载工具进行解压到本地目录，选择【玄讯图片下载工具.exe】打开工具\\****</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/%E5%AF%BC%E5%87%BA%E5%9B%BE%E7%89%87%E6%94%B9%E5%90%8D%E5%8F%8A%E6%B0%B4%E5%8D%B0%E4%BF%AE%E6%94%B9%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3855.png" alt=""></p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/%E5%AF%BC%E5%87%BA%E5%9B%BE%E7%89%87%E6%94%B9%E5%90%8D%E5%8F%8A%E6%B0%B4%E5%8D%B0%E4%BF%AE%E6%94%B9%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3858.png" alt=""></p><p><strong>2、</strong>**<em>\\</em> 在玄讯图片下载工具的登录页面选择第一栏选择《河北养元》，第二栏和第三栏输入登录web端的帐号密码，点击登录。\\****</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/%E5%AF%BC%E5%87%BA%E5%9B%BE%E7%89%87%E6%94%B9%E5%90%8D%E5%8F%8A%E6%B0%B4%E5%8D%B0%E4%BF%AE%E6%94%B9%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3916.png" alt=""></p><p><strong>3、</strong>**<em>\\</em> 选择已经在销售管理系统下载到本地的文件\\****</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/%E5%AF%BC%E5%87%BA%E5%9B%BE%E7%89%87%E6%94%B9%E5%90%8D%E5%8F%8A%E6%B0%B4%E5%8D%B0%E4%BF%AE%E6%94%B9%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3939.png" alt=""></p><p>点击弹出文件选择界面，选择需要下载图片的文件，一次只能选择一个文件下载。</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/%E5%AF%BC%E5%87%BA%E5%9B%BE%E7%89%87%E6%94%B9%E5%90%8D%E5%8F%8A%E6%B0%B4%E5%8D%B0%E4%BF%AE%E6%94%B9%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3978.png" alt=""></p><p><strong>4、</strong>**<em>\\</em> 第4步选择文件后工具自动处理，处理完毕后，点击【导出文件】按钮，将文件保存到电脑本地，并且是以文件夹形式保存。\\****</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/%E5%AF%BC%E5%87%BA%E5%9B%BE%E7%89%87%E6%94%B9%E5%90%8D%E5%8F%8A%E6%B0%B4%E5%8D%B0%E4%BF%AE%E6%94%B9%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A31037.png" alt=""></p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/%E5%AF%BC%E5%87%BA%E5%9B%BE%E7%89%87%E6%94%B9%E5%90%8D%E5%8F%8A%E6%B0%B4%E5%8D%B0%E4%BF%AE%E6%94%B9%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A31039.png" alt=""></p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/%E5%AF%BC%E5%87%BA%E5%9B%BE%E7%89%87%E6%94%B9%E5%90%8D%E5%8F%8A%E6%B0%B4%E5%8D%B0%E4%BF%AE%E6%94%B9%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A31041.png" alt=""></p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/%E5%AF%BC%E5%87%BA%E5%9B%BE%E7%89%87%E6%94%B9%E5%90%8D%E5%8F%8A%E6%B0%B4%E5%8D%B0%E4%BF%AE%E6%94%B9%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A31043.png" alt=""></p><p><strong>5、</strong>**<em>\\</em> 打开第6步保存的文件夹，可以看到专门存放所有图片的文件夹【images_temp】，还有已经将图片格式转为链接的文件：\\****</p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/%E5%AF%BC%E5%87%BA%E5%9B%BE%E7%89%87%E6%94%B9%E5%90%8D%E5%8F%8A%E6%B0%B4%E5%8D%B0%E4%BF%AE%E6%94%B9%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A31105.png" alt=""></p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/%E5%AF%BC%E5%87%BA%E5%9B%BE%E7%89%87%E6%94%B9%E5%90%8D%E5%8F%8A%E6%B0%B4%E5%8D%B0%E4%BF%AE%E6%94%B9%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A31106.png" alt=""></p><p><img src="http://apaas.wxchina.com:8881/wp-content/uploads/%E5%AF%BC%E5%87%BA%E5%9B%BE%E7%89%87%E6%94%B9%E5%90%8D%E5%8F%8A%E6%B0%B4%E5%8D%B0%E4%BF%AE%E6%94%B9%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A31108.png" alt=""></p><p>六、开发人员具体操作步骤</p><p>1、创建临时表 – 以下有函数自动检索此表，识别并修改图片水印和名称</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> &quot;</span><span style="color:#B392F0;">public</span><span style="color:#E1E4E8;">&quot;.</span><span style="color:#9ECBFF;">&quot;tn_photoaddname&quot;</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;tn_id&quot;</span><span style="color:#E1E4E8;"> int4 </span><span style="color:#F97583;">NOT NULL</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">-- id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;tablename&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">COLLATE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;pg_catalog&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#9ECBFF;">&quot;default&quot;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">-- 业务表名</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;keyfiledname&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">COLLATE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;pg_catalog&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#9ECBFF;">&quot;default&quot;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">-- 业务表ID</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;photofiledname&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">COLLATE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;pg_catalog&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#9ECBFF;">&quot;default&quot;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">-- 图片字段名称</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;storefiledname&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">COLLATE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;pg_catalog&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#9ECBFF;">&quot;default&quot;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">-- 终端id字段名称</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;createopfiledname&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">COLLATE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;pg_catalog&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#9ECBFF;">&quot;default&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">-- 创建人字段名称</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;remark&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">COLLATE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;pg_catalog&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#9ECBFF;">&quot;default&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">-- 备注说明</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;status&quot;</span><span style="color:#E1E4E8;"> int4  </span><span style="color:#6A737D;">-- 是否启用</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> &quot;</span><span style="color:#6F42C1;">public</span><span style="color:#24292E;">&quot;.</span><span style="color:#032F62;">&quot;tn_photoaddname&quot;</span><span style="color:#24292E;"> (</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;tn_id&quot;</span><span style="color:#24292E;"> int4 </span><span style="color:#D73A49;">NOT NULL</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">-- id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;tablename&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">255</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">COLLATE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pg_catalog&quot;</span><span style="color:#24292E;">.</span><span style="color:#032F62;">&quot;default&quot;</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">-- 业务表名</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;keyfiledname&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">255</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">COLLATE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pg_catalog&quot;</span><span style="color:#24292E;">.</span><span style="color:#032F62;">&quot;default&quot;</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">-- 业务表ID</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;photofiledname&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">255</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">COLLATE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pg_catalog&quot;</span><span style="color:#24292E;">.</span><span style="color:#032F62;">&quot;default&quot;</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">-- 图片字段名称</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;storefiledname&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">255</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">COLLATE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pg_catalog&quot;</span><span style="color:#24292E;">.</span><span style="color:#032F62;">&quot;default&quot;</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">-- 终端id字段名称</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;createopfiledname&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">255</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">COLLATE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pg_catalog&quot;</span><span style="color:#24292E;">.</span><span style="color:#032F62;">&quot;default&quot;</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">-- 创建人字段名称</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;remark&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">255</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">COLLATE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pg_catalog&quot;</span><span style="color:#24292E;">.</span><span style="color:#032F62;">&quot;default&quot;</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">-- 备注说明</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;status&quot;</span><span style="color:#24292E;"> int4  </span><span style="color:#6A737D;">-- 是否启用</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>2、导入函数 ， 此函数循环上面中的内容依次更新，更新内容包含两种逻辑。Storefiledname 不为空数据，对给图片打上终端名称信息，具体为 终端名称_提交人名称_年月日_GUID.jpg；Storefiledname为空数据，给图片打上无终端名称信息，具体为 提交人名称_年月日_GUID.jpg。</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">CREATE OR REPLACE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FUNCTION</span><span style="color:#E1E4E8;"> &quot;</span><span style="color:#B392F0;">public</span><span style="color:#E1E4E8;">&quot;.</span><span style="color:#9ECBFF;">&quot;f_update_storelatlong_temp&quot;</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">RETURNS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;pg_catalog&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#9ECBFF;">&quot;void&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> $BODY$</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> indexs </span><span style="color:#F97583;">integer</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> keyfiledname </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> storefiledname </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> createopfiledname </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> sql_text </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">8000</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">begin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--insert into tn_photoaddname(tn_id,tablename,keyfiledname,photofiledname,storefiledname,createopfiledname,remark)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--values(1,&#39;kx_kq_storeinandout&#39;,&#39;id&#39;,&#39;signinpictures&#39;,&#39;storeid&#39;,&#39;submitterid&#39;,&#39;终端签到拍照&#39;);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--insert into tn_photoaddname(tn_id,tablename,keyfiledname,photofiledname,storefiledname,createopfiledname,remark)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--values(2,&#39;kx_store_competition_record&#39;,&#39;id&#39;,&#39;display_photo&#39;,&#39;store_id&#39;,&#39;createop&#39;,&#39;陈列拍照&#39;);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> indexs :</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">WHILE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Exists</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tn_photoaddname </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> tn_id </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> indexs </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">LOOP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">-- 循环下一条</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> tn_id </span><span style="color:#F97583;">into</span><span style="color:#E1E4E8;"> indexs </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tn_photoaddname </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> tn_id </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> indexs </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> tn_id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">-- 读取值</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tablename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">into</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tn_photoaddname a </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tn_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> indexs;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                       </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">keyfiledname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">into</span><span style="color:#E1E4E8;"> keyfiledname </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tn_photoaddname a </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tn_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> indexs;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">photofiledname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">into</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tn_photoaddname a </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tn_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> indexs;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">storefiledname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">into</span><span style="color:#E1E4E8;"> storefiledname </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tn_photoaddname a </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tn_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> indexs;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">createopfiledname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">into</span><span style="color:#E1E4E8;"> createopfiledname </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tn_photoaddname a </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tn_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> indexs;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">EXECUTE</span><span style="color:#E1E4E8;"> sql_text;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> storefiledname </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> storefiledname </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                    raise notice </span><span style="color:#9ECBFF;">&#39;%&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;storefiledname&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                     sql_text :</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">update &#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;">&#39; set &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; = temp.newsigninpictures from (</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">select a.sid,&#39;&#39;[&#39;&#39; || string_agg(&#39;&#39;{&quot;source&quot;:&quot;&#39;&#39; || a.source || &#39;&#39;&quot;,&quot;datetime&quot;:&quot;&#39;&#39; || a.datetime || &#39;&#39;&quot;,&quot;storage&quot;:&quot;&#39;&#39; || COALESCE(a.storage,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;watermark&quot;:&quot;&#39;&#39; || COALESCE(a.watermark,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;detectResult&quot;:&quot;&#39;&#39; || COALESCE(a.detectResult,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;displayname&quot;:&quot;&#39;&#39; || c.orgname || &#39;&#39;_&#39;&#39; || to_char(to_timestamp(a.datetime::bigint / 1000), &#39;&#39;YYYYMMDD&#39;&#39;) || &#39;&#39;&quot;&#39;&#39; || case when a.&quot;filePath&quot; is not null and a.&quot;filePath&quot; &lt;&gt; &#39;&#39;&#39;&#39; then &#39;&#39;,&quot;filePath&quot;:&quot;&#39;&#39; || a.&quot;filePath&quot; || &#39;&#39;&quot;,&quot;isFake&quot;:&quot;&#39;&#39; || a.&quot;isFake&quot; || &#39;&#39;&quot;,&quot;identityId&quot;:&quot;&#39;&#39; || a.&quot;identityId&quot; || &#39;&#39;&quot;&#39;&#39; else &#39;&#39;&#39;&#39; end || &#39;&#39;}&#39;&#39; ,&#39;&#39;,&#39;&#39;) ||&#39;&#39;]&#39;&#39; as newsigninpictures from (</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">SELECT id,&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> keyfiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; as sid,&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> createopfiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; as submitterid,t.* FROM &#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;">&#39;, jsonb_populate_recordset(null::temp_pictures, replace(replace(&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;,chr(10),&#39;&#39;&#39;&#39;),chr(9),&#39;&#39;&#39;&#39;)::jsonb) as t where &#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; is not null and &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &lt;&gt; &#39;&#39;&#39;&#39; and &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &lt;&gt; chr(034) || chr(034) and &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; not like &#39;&#39;%\\\\&quot;%&#39;&#39; and &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;.platcreatetime &gt;= now() - interval &#39;&#39;20 day&#39;&#39;) a</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">left join pl_orgstruct c on c.orgstructid = a.submitterid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">group by a.sid)temp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">where temp.sid = &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> keyfiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">update &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; set &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; = replace(replace(&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;,chr(10),&#39;&#39; &#39;&#39;),chr(9),&#39;&#39; &#39;&#39;) where &#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; like &#39;&#39;%&#39;&#39; || chr(10) || &#39;&#39;%&#39;&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> createopfiledname </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> createopfiledname </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                raise notice </span><span style="color:#9ECBFF;">&#39;%&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;createopfiledname&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        sql_text :</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">update &#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;">&#39; set &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; = temp.newsigninpictures from (</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">select a.sid,&#39;&#39;[&#39;&#39; || string_agg(&#39;&#39;{&quot;source&quot;:&quot;&#39;&#39; || a.source || &#39;&#39;&quot;,&quot;datetime&quot;:&quot;&#39;&#39; || a.datetime || &#39;&#39;&quot;,&quot;storage&quot;:&quot;&#39;&#39; || COALESCE(a.storage,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;watermark&quot;:&quot;&#39;&#39; || b.storename || &#39;&#39;_&#39;&#39; || to_char(to_timestamp(a.datetime::bigint / 1000), &#39;&#39;YYYYMMDD&#39;&#39;) || &#39;&#39;&quot;,&quot;detectResult&quot;:&quot;&#39;&#39; || COALESCE(a.detectResult,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;displayname&quot;:&quot;&#39;&#39; || b.storename || &#39;&#39;_&#39;&#39; || to_char(to_timestamp(a.datetime::bigint / 1000), &#39;&#39;YYYYMMDD&#39;&#39;) || &#39;&#39;&quot;&#39;&#39; || case when a.&quot;filePath&quot; is not null and a.&quot;filePath&quot; &lt;&gt; &#39;&#39;&#39;&#39; then &#39;&#39;,&quot;filePath&quot;:&quot;&#39;&#39; || a.&quot;filePath&quot; || &#39;&#39;&quot;,&quot;isFake&quot;:&quot;&#39;&#39; || a.&quot;isFake&quot; || &#39;&#39;&quot;,&quot;identityId&quot;:&quot;&#39;&#39; || a.&quot;identityId&quot; || &#39;&#39;&quot;&#39;&#39; else &#39;&#39;&#39;&#39; end || &#39;&#39;}&#39;&#39; ,&#39;&#39;,&#39;&#39;) ||&#39;&#39;]&#39;&#39; as newsigninpictures from (</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">SELECT id,&#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> storefiledname </span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;">&#39; as storeid,&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> keyfiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; as sid,t.* FROM &#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;">&#39;, jsonb_populate_recordset(null::temp_pictures, replace(replace(&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;,chr(10),&#39;&#39;&#39;&#39;),chr(9),&#39;&#39;&#39;&#39;)::jsonb) as t where &#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; is not null and &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &lt;&gt; &#39;&#39;&#39;&#39; and &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &lt;&gt; chr(034) || chr(034) and &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; not like &#39;&#39;%\\\\&quot;%&#39;&#39; and &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;.platcreatetime &gt;= now() - interval &#39;&#39;20 day&#39;&#39;) a</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">left join (select id,storename from kx_kq_store union all select id,storename from tn_marketinspection_store) b on a.storeid = b.id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">group by a.sid)temp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">where temp.sid = &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> keyfiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">update &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; set &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; = replace(replace(&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;,chr(10),&#39;&#39; &#39;&#39;),chr(9),&#39;&#39; &#39;&#39;) where &#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; like &#39;&#39;%&#39;&#39; || chr(10) || &#39;&#39;%&#39;&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">ELSE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        raise notice </span><span style="color:#9ECBFF;">&#39;%&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;all&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                sql_text :</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;update &#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;">&#39; set &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; = temp.newsigninpictures from (</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">select a.sid,&#39;&#39;[&#39;&#39; || string_agg(&#39;&#39;{&quot;source&quot;:&quot;&#39;&#39; || a.source || &#39;&#39;&quot;,&quot;datetime&quot;:&quot;&#39;&#39; || a.datetime || &#39;&#39;&quot;,&quot;storage&quot;:&quot;&#39;&#39; || COALESCE(a.storage,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;watermark&quot;:&quot;&#39;&#39; || COALESCE(a.watermark,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;detectResult&quot;:&quot;&#39;&#39; || COALESCE(a.detectResult,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;displayname&quot;:&quot;&#39;&#39; || b.storename || &#39;&#39;_&#39;&#39; || c.orgname || &#39;&#39;_&#39;&#39; || to_char(to_timestamp(a.datetime::bigint / 1000), &#39;&#39;YYYYMMDD&#39;&#39;) || &#39;&#39;&quot;&#39;&#39; || case when a.&quot;filePath&quot; is not null and a.&quot;filePath&quot; &lt;&gt; &#39;&#39;&#39;&#39; then &#39;&#39;,&quot;filePath&quot;:&quot;&#39;&#39; || a.&quot;filePath&quot; || &#39;&#39;&quot;,&quot;isFake&quot;:&quot;&#39;&#39; || a.&quot;isFake&quot; || &#39;&#39;&quot;,&quot;identityId&quot;:&quot;&#39;&#39; || a.&quot;identityId&quot; || &#39;&#39;&quot;&#39;&#39; else &#39;&#39;&#39;&#39; end || &#39;&#39;}&#39;&#39; ,&#39;&#39;,&#39;&#39;) ||&#39;&#39;]&#39;&#39; as newsigninpictures from (</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">SELECT id,&#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> storefiledname </span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;">&#39; as storeid,&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> keyfiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; as sid,&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> createopfiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; as submitterid,t.* FROM &#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;">&#39;, jsonb_populate_recordset(null::temp_pictures, replace(replace(&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;,chr(10),&#39;&#39;&#39;&#39;),chr(9),&#39;&#39;&#39;&#39;)::jsonb) as t where &#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; is not null and &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &lt;&gt; &#39;&#39;&#39;&#39; and &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &lt;&gt; chr(034) || chr(034) and &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; not like &#39;&#39;%\\\\&quot;%&#39;&#39; and &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;.platcreatetime &gt;= now() - interval &#39;&#39;20 day&#39;&#39;) a</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">left join kx_kq_store b on a.storeid = b.id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">left join pl_orgstruct c on c.orgstructid = a.submitterid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">group by b.id,a.sid)temp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">where temp.sid = &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> keyfiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">update &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> tablename </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; set &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; = replace(replace(&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;,chr(10),&#39;&#39; &#39;&#39;),chr(9),&#39;&#39; &#39;&#39;) where &#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; like &#39;&#39;%&#39;&#39; || chr(10) || &#39;&#39;%&#39;&#39; OR &#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> photofiledname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; like &#39;&#39;%&#39;&#39; || chr(9) || &#39;&#39;%&#39;&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">         raise notice </span><span style="color:#9ECBFF;">&#39;%,%&#39;</span><span style="color:#E1E4E8;">,indexs,sql_text;    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">EXECUTE</span><span style="color:#E1E4E8;"> sql_text;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LOOP</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">$BODY$</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LANGUAGE</span><span style="color:#E1E4E8;"> plpgsql VOLATILE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> COST </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FUNCTION</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;public&quot;</span><span style="color:#E1E4E8;">.</span><span style="color:#9ECBFF;">&quot;f_update_storelatlong_temp&quot;</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">OWNER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TO</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">CREATE OR REPLACE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FUNCTION</span><span style="color:#24292E;"> &quot;</span><span style="color:#6F42C1;">public</span><span style="color:#24292E;">&quot;.</span><span style="color:#032F62;">&quot;f_update_storelatlong_temp&quot;</span><span style="color:#24292E;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">RETURNS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pg_catalog&quot;</span><span style="color:#24292E;">.</span><span style="color:#032F62;">&quot;void&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> $BODY$</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> indexs </span><span style="color:#D73A49;">integer</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> keyfiledname </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> storefiledname </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> createopfiledname </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> sql_text </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">8000</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">begin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--insert into tn_photoaddname(tn_id,tablename,keyfiledname,photofiledname,storefiledname,createopfiledname,remark)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--values(1,&#39;kx_kq_storeinandout&#39;,&#39;id&#39;,&#39;signinpictures&#39;,&#39;storeid&#39;,&#39;submitterid&#39;,&#39;终端签到拍照&#39;);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--insert into tn_photoaddname(tn_id,tablename,keyfiledname,photofiledname,storefiledname,createopfiledname,remark)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--values(2,&#39;kx_store_competition_record&#39;,&#39;id&#39;,&#39;display_photo&#39;,&#39;store_id&#39;,&#39;createop&#39;,&#39;陈列拍照&#39;);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> indexs :</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">WHILE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Exists</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tn_photoaddname </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> tn_id </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> indexs </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">status</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">LOOP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">-- 循环下一条</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> tn_id </span><span style="color:#D73A49;">into</span><span style="color:#24292E;"> indexs </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tn_photoaddname </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> tn_id </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> indexs </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">status</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> tn_id;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#6A737D;">-- 读取值</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tablename</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">into</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tn_photoaddname a </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tn_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> indexs;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                       </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">keyfiledname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">into</span><span style="color:#24292E;"> keyfiledname </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tn_photoaddname a </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tn_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> indexs;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">photofiledname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">into</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tn_photoaddname a </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tn_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> indexs;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">storefiledname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">into</span><span style="color:#24292E;"> storefiledname </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tn_photoaddname a </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tn_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> indexs;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">createopfiledname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">into</span><span style="color:#24292E;"> createopfiledname </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tn_photoaddname a </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tn_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> indexs;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">EXECUTE</span><span style="color:#24292E;"> sql_text;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> storefiledname </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> storefiledname </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                    raise notice </span><span style="color:#032F62;">&#39;%&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;storefiledname&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                     sql_text :</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">update &#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">||</span><span style="color:#032F62;">&#39; set &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; = temp.newsigninpictures from (</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">select a.sid,&#39;&#39;[&#39;&#39; || string_agg(&#39;&#39;{&quot;source&quot;:&quot;&#39;&#39; || a.source || &#39;&#39;&quot;,&quot;datetime&quot;:&quot;&#39;&#39; || a.datetime || &#39;&#39;&quot;,&quot;storage&quot;:&quot;&#39;&#39; || COALESCE(a.storage,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;watermark&quot;:&quot;&#39;&#39; || COALESCE(a.watermark,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;detectResult&quot;:&quot;&#39;&#39; || COALESCE(a.detectResult,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;displayname&quot;:&quot;&#39;&#39; || c.orgname || &#39;&#39;_&#39;&#39; || to_char(to_timestamp(a.datetime::bigint / 1000), &#39;&#39;YYYYMMDD&#39;&#39;) || &#39;&#39;&quot;&#39;&#39; || case when a.&quot;filePath&quot; is not null and a.&quot;filePath&quot; &lt;&gt; &#39;&#39;&#39;&#39; then &#39;&#39;,&quot;filePath&quot;:&quot;&#39;&#39; || a.&quot;filePath&quot; || &#39;&#39;&quot;,&quot;isFake&quot;:&quot;&#39;&#39; || a.&quot;isFake&quot; || &#39;&#39;&quot;,&quot;identityId&quot;:&quot;&#39;&#39; || a.&quot;identityId&quot; || &#39;&#39;&quot;&#39;&#39; else &#39;&#39;&#39;&#39; end || &#39;&#39;}&#39;&#39; ,&#39;&#39;,&#39;&#39;) ||&#39;&#39;]&#39;&#39; as newsigninpictures from (</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">SELECT id,&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> keyfiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; as sid,&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> createopfiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; as submitterid,t.* FROM &#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">||</span><span style="color:#032F62;">&#39;, jsonb_populate_recordset(null::temp_pictures, replace(replace(&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;,chr(10),&#39;&#39;&#39;&#39;),chr(9),&#39;&#39;&#39;&#39;)::jsonb) as t where &#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; is not null and &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &lt;&gt; &#39;&#39;&#39;&#39; and &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &lt;&gt; chr(034) || chr(034) and &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; not like &#39;&#39;%\\\\&quot;%&#39;&#39; and &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;.platcreatetime &gt;= now() - interval &#39;&#39;20 day&#39;&#39;) a</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">left join pl_orgstruct c on c.orgstructid = a.submitterid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">group by a.sid)temp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">where temp.sid = &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> keyfiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">update &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; set &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; = replace(replace(&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;,chr(10),&#39;&#39; &#39;&#39;),chr(9),&#39;&#39; &#39;&#39;) where &#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; like &#39;&#39;%&#39;&#39; || chr(10) || &#39;&#39;%&#39;&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> createopfiledname </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> createopfiledname </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                raise notice </span><span style="color:#032F62;">&#39;%&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;createopfiledname&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        sql_text :</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">update &#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">||</span><span style="color:#032F62;">&#39; set &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; = temp.newsigninpictures from (</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">select a.sid,&#39;&#39;[&#39;&#39; || string_agg(&#39;&#39;{&quot;source&quot;:&quot;&#39;&#39; || a.source || &#39;&#39;&quot;,&quot;datetime&quot;:&quot;&#39;&#39; || a.datetime || &#39;&#39;&quot;,&quot;storage&quot;:&quot;&#39;&#39; || COALESCE(a.storage,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;watermark&quot;:&quot;&#39;&#39; || b.storename || &#39;&#39;_&#39;&#39; || to_char(to_timestamp(a.datetime::bigint / 1000), &#39;&#39;YYYYMMDD&#39;&#39;) || &#39;&#39;&quot;,&quot;detectResult&quot;:&quot;&#39;&#39; || COALESCE(a.detectResult,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;displayname&quot;:&quot;&#39;&#39; || b.storename || &#39;&#39;_&#39;&#39; || to_char(to_timestamp(a.datetime::bigint / 1000), &#39;&#39;YYYYMMDD&#39;&#39;) || &#39;&#39;&quot;&#39;&#39; || case when a.&quot;filePath&quot; is not null and a.&quot;filePath&quot; &lt;&gt; &#39;&#39;&#39;&#39; then &#39;&#39;,&quot;filePath&quot;:&quot;&#39;&#39; || a.&quot;filePath&quot; || &#39;&#39;&quot;,&quot;isFake&quot;:&quot;&#39;&#39; || a.&quot;isFake&quot; || &#39;&#39;&quot;,&quot;identityId&quot;:&quot;&#39;&#39; || a.&quot;identityId&quot; || &#39;&#39;&quot;&#39;&#39; else &#39;&#39;&#39;&#39; end || &#39;&#39;}&#39;&#39; ,&#39;&#39;,&#39;&#39;) ||&#39;&#39;]&#39;&#39; as newsigninpictures from (</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">SELECT id,&#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> storefiledname </span><span style="color:#D73A49;">||</span><span style="color:#032F62;">&#39; as storeid,&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> keyfiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; as sid,t.* FROM &#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">||</span><span style="color:#032F62;">&#39;, jsonb_populate_recordset(null::temp_pictures, replace(replace(&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;,chr(10),&#39;&#39;&#39;&#39;),chr(9),&#39;&#39;&#39;&#39;)::jsonb) as t where &#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; is not null and &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &lt;&gt; &#39;&#39;&#39;&#39; and &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &lt;&gt; chr(034) || chr(034) and &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; not like &#39;&#39;%\\\\&quot;%&#39;&#39; and &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;.platcreatetime &gt;= now() - interval &#39;&#39;20 day&#39;&#39;) a</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">left join (select id,storename from kx_kq_store union all select id,storename from tn_marketinspection_store) b on a.storeid = b.id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">group by a.sid)temp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">where temp.sid = &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> keyfiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">update &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; set &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; = replace(replace(&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;,chr(10),&#39;&#39; &#39;&#39;),chr(9),&#39;&#39; &#39;&#39;) where &#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; like &#39;&#39;%&#39;&#39; || chr(10) || &#39;&#39;%&#39;&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">ELSE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        raise notice </span><span style="color:#032F62;">&#39;%&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;all&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                sql_text :</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;update &#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">||</span><span style="color:#032F62;">&#39; set &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; = temp.newsigninpictures from (</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">select a.sid,&#39;&#39;[&#39;&#39; || string_agg(&#39;&#39;{&quot;source&quot;:&quot;&#39;&#39; || a.source || &#39;&#39;&quot;,&quot;datetime&quot;:&quot;&#39;&#39; || a.datetime || &#39;&#39;&quot;,&quot;storage&quot;:&quot;&#39;&#39; || COALESCE(a.storage,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;watermark&quot;:&quot;&#39;&#39; || COALESCE(a.watermark,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;detectResult&quot;:&quot;&#39;&#39; || COALESCE(a.detectResult,&#39;&#39;&#39;&#39;) || &#39;&#39;&quot;,&quot;displayname&quot;:&quot;&#39;&#39; || b.storename || &#39;&#39;_&#39;&#39; || c.orgname || &#39;&#39;_&#39;&#39; || to_char(to_timestamp(a.datetime::bigint / 1000), &#39;&#39;YYYYMMDD&#39;&#39;) || &#39;&#39;&quot;&#39;&#39; || case when a.&quot;filePath&quot; is not null and a.&quot;filePath&quot; &lt;&gt; &#39;&#39;&#39;&#39; then &#39;&#39;,&quot;filePath&quot;:&quot;&#39;&#39; || a.&quot;filePath&quot; || &#39;&#39;&quot;,&quot;isFake&quot;:&quot;&#39;&#39; || a.&quot;isFake&quot; || &#39;&#39;&quot;,&quot;identityId&quot;:&quot;&#39;&#39; || a.&quot;identityId&quot; || &#39;&#39;&quot;&#39;&#39; else &#39;&#39;&#39;&#39; end || &#39;&#39;}&#39;&#39; ,&#39;&#39;,&#39;&#39;) ||&#39;&#39;]&#39;&#39; as newsigninpictures from (</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">SELECT id,&#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> storefiledname </span><span style="color:#D73A49;">||</span><span style="color:#032F62;">&#39; as storeid,&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> keyfiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; as sid,&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> createopfiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; as submitterid,t.* FROM &#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">||</span><span style="color:#032F62;">&#39;, jsonb_populate_recordset(null::temp_pictures, replace(replace(&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;,chr(10),&#39;&#39;&#39;&#39;),chr(9),&#39;&#39;&#39;&#39;)::jsonb) as t where &#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; is not null and &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &lt;&gt; &#39;&#39;&#39;&#39; and &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &lt;&gt; chr(034) || chr(034) and &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; not like &#39;&#39;%\\\\&quot;%&#39;&#39; and &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;.platcreatetime &gt;= now() - interval &#39;&#39;20 day&#39;&#39;) a</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">left join kx_kq_store b on a.storeid = b.id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">left join pl_orgstruct c on c.orgstructid = a.submitterid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">group by b.id,a.sid)temp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">where temp.sid = &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> keyfiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">update &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> tablename </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; set &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; = replace(replace(&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;,chr(10),&#39;&#39; &#39;&#39;),chr(9),&#39;&#39; &#39;&#39;) where &#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; like &#39;&#39;%&#39;&#39; || chr(10) || &#39;&#39;%&#39;&#39; OR &#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> photofiledname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; like &#39;&#39;%&#39;&#39; || chr(9) || &#39;&#39;%&#39;&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">         raise notice </span><span style="color:#032F62;">&#39;%,%&#39;</span><span style="color:#24292E;">,indexs,sql_text;    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">EXECUTE</span><span style="color:#24292E;"> sql_text;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LOOP</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">$BODY$</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">LANGUAGE</span><span style="color:#24292E;"> plpgsql VOLATILE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> COST </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FUNCTION</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;public&quot;</span><span style="color:#24292E;">.</span><span style="color:#032F62;">&quot;f_update_storelatlong_temp&quot;</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">OWNER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TO</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br></div></div><p>3、 FLYCODE中创建定时任务执行，依据实际业务需要确认执行周期。</p><p>4、下载图片包含名称必须使用最新导出工具，最新工具可以想平台索取。</p><p>相关文件下载：<br><a href="http://apaas.wxchina.com:8881/wp-content/uploads/1.COM-BC031-FC001-%E5%AF%BC%E5%87%BA%E5%9B%BE%E7%89%87%E6%94%B9%E5%90%8D%E5%8F%8A%E6%B0%B4%E5%8D%B0.zip" title="1.COM-BC031-FC001 导出图片改名及水印" target="_blank" rel="noreferrer">1.COM-BC031-FC001 导出图片改名及水印</a></p>`,53),e=[o];function t(c,r,E,y,i,u){return n(),a("div",null,e)}const d=s(p,[["render",t]]);export{m as __pageData,d as default};
